---
slug: "bug-fix"
description: "バグの調査→修正→検証→コミット（必要ならPR）までを、差分根拠と安全確認つきで一気通貫に実行する。星来がバグを退治する。"
trigger: "manual"
---

# 🐛 bug-fix — バグ修正ワークフロー

**差分根拠**と**安全確認**つきバグを修正します。

---

## 定義（このワークフローの狙い）
バグ修正は「直す」だけで終わりません。Convoy では次を **一体で完了**させます。

- **再現**（現象を固定し、再現条件を言語化）
- **原因特定**（根拠を示す）
- **最小修正**（副作用を抑制）
- **検証**（回帰なしを証明）
- **記録**（コミット/（必要なら）PR/完了報告）

---

## SoT（Source of Truth）
- **スタック・実行コマンド**: `assets/branding/<productId>/brief.md` を正本（SoT）とする  
  ※ Web / Flutter / その他により検証コマンドが変わるため、必ず brief を参照する。
- **ワークフロー正本**: `.agent/INDEX.md`（利用可能コマンド一覧）
- **コミット運用**: `/git-auto-commit` の戦略に従う

---

## 事前入力（ユーザーから受け取る情報）
最低限、以下を埋めてください（未確定は未確定のままでOK）。

1. **現象（Symptom）**: 何が起きている？
2. **期待動作（Expected）**: 本来どうなるべき？
3. **再現手順（Repro）**: 手順 / 入力値 / 画面遷移 / API呼び出し
4. **発生条件（Env）**: OS / 実行モード / ブランチ / バージョン
5. **ログ/エラー（Evidence）**: エラーメッセージ、スクリーンショット、スタックトレース

> ここが薄いと、直しても「直った気がする」で終わってしまう。  
> だから最初に、**再現条件を固定**します。

---

## 成果物（生成・更新されるもの）
- 修正コード（対象ファイル）
- **再現テスト**（可能なら必須）
- 検証結果（コマンド結果、スクリーンショット、ログ要約）
- コミット（必要なら PR 用の説明文）

---

## 重要ルール（Convoy品質ガード）
- **最小変更**: 差分は小さく、目的に直結しない改変はしない
- **差分根拠**: 「なぜその修正が必要か」を、ログ・コード・再現で説明できること
- **破壊的操作は承認必須**: 削除、リネーム大量、強制 push、依存更新、デプロイはユーザー確認
- **未確定事項はDecision化**: 勝手に仕様確定しない

---

# 手順

## Step 1: 🔍 バグの確認（再現条件の固定）
以下のテンプレを埋めて **1つの文章**にまとめる：

- 現象: `<Symptom>`
- 期待: `<Expected>`
- 再現: `<Repro>`
- 条件: `<Env>`
- 証拠: `<Error / Logs>`

**ゴール**: 「誰がやっても再現する」状態にする。

---

## Step 2: 🕵️ 原因調査（根拠ベース）
やること（順番）:

1. **ログとスタックトレース**の読み取り（入口を特定）
2. **直近の変更差分**の確認（git log / blame）
3. **境界（入力・API・DB・状態遷移）**の確認
4. 「原因候補」を2〜3個に絞り、**最短で潰す検証**を設計する

> ただし、“推測で修正”はしない。必ず根拠を残すこと。

---

## Step 3: 🌿 ブランチ作成 // turbo
ブランチ名は「目的が分かる」形に統一。

```bash
git checkout -b fix/<short-kebab-bug-title>
# 例: git checkout -b fix/login-null-user
```

---

## Step 4: 🧪 失敗するテスト（再現テスト）を作る
優先順位：

1. **ユニットテスト/ロジックテスト**（最速・最安）
2. **統合テスト**（境界のバグに有効）
3. **E2E/手順固定メモ**（テストが難しい場合の代替。最低限“再現手順”を厳密に残す）

テストが作れない場合は、代替として以下を必須にする：
- 再現手順の固定（入力値・画面・API・時刻・データ条件）
- 修正前後の差（スクショ/ログ/結果比較）

---

## Step 5: 🔧 修正（最小・局所・安全）
修正の方針：

- **原因へ最短で効く変更**だけを入れる
- 例外処理・null処理は「境界」で吸収（無限に散らさない）
- 仕様に関わる変更は **Decision** として扱い、ユーザー確認を挟む

---

## Step 6: ✅ コード検証（回帰なしの証明） // turbo
`brief.md` のスタックに従って、以下から該当するものを実行する（例）。

### Web（Node / pnpm 系の例）
```bash
pnpm -v
pnpm install
pnpm lint
pnpm test
pnpm build
```

### Flutter の例
```bash
flutter --version
flutter pub get
flutter analyze
flutter test
# 必要なら: flutter build <target>
```

### 共通（最低限）
- 追加した再現テストが **修正前はFail / 修正後はPass**
- 重要導線の手動スモーク（ログイン、主要画面遷移など）
- README / docs のリンク切れ（大小文字含む）がない

> もし `review-repo-quality` が利用可能なら、最後に `/review-repo-quality` を回してもよい（品質ゲート）。

---

## Step 7: 💾 コミット（/git-auto-commit 戦略に準拠）
コミット方針：
- **Type**: `fix`
- 1コミットで直せるなら1コミット（過剰分割しない）
- ただし、**テスト追加**と**修正**は分けてもよい（レビュー容易性）

メッセージ例：

```text
fix: <bug-title>

- symptom: <何が起きていたか>
- root cause: <原因（根拠）>
- fix: <何を変えたか>
- tests: <追加/更新したテスト>
```

---

## Step 8: 🧾 完了報告（Convoy標準フォーマット）
以下のテンプレで報告する。

```markdown
## 🐛 バグ退治完了！

### 現象（Symptom）
- <Symptom>

### 期待動作（Expected）
- <Expected>

### 原因（Root Cause）※根拠つき
- <Cause>
- 根拠: <ログ/該当コード/再現ポイント>

### 修正（Fix）
- <Fix summary>
- 影響範囲: <範囲（狭いほど良い）>

### 変更したファイル
- <path> (修正)
- <path> (テスト追加/更新)

### 検証結果
- コマンド: <実行したコマンド一覧>
- 結果: Pass / Fail（Failなら次の手）
- 追加テスト: <Fail→Pass を確認したテスト>

### リスク（あれば）
- <残課題/注意点>

### 次のアクション（必要なら）
- <PR作成、デプロイ、追加検証など>
```


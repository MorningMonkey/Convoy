---
slug: "code-review"
description: "PRやコード変更に対して、SoT参照・差分根拠・安全ガードつきで体系的なレビューを実施し、Must Fix / Should Fix / Suggestion / Good Pointsで報告する。"
trigger: "manual"
---

# ✅ code-review — コードレビュー

Convoy のコードレビューは「雰囲気」ではなく、**根拠・再現・影響範囲**で判断します。  
目的は、変更を止めることではなく **安全に出荷できる状態へ収束**させること。

---

## 定義（このワークフローの狙い）
以下を一貫して行う。

- **変更意図の把握**（何を解決するための変更か）
- **設計/アーキテクチャ整合**（既存の導線・責務に合うか）
- **品質・安全**（可読性、保守性、型、安全性、セキュリティ）
- **検証**（テスト/ビルド/動作確認の根拠）
- **出荷判断**（Pass / Risk / Action）
- **レビュー記録**（Must Fix / Should Fix / Suggestion / Good Points）

---

## SoT（Source of Truth）
- **スタック・品質ゲート**: `assets/branding/<productId>/brief.md` を正本（SoT）
- **利用可能ワークフロー一覧**: `.agent/INDEX.md`
- **品質診断（任意）**: `/review-repo-quality`（利用可能なら補助として実行可）
- **管制仕様**: `ANTIGRAVITY_AGENT_CONTROL_SPEC.md`

---

## 入力（レビュー対象）
- PR（差分 + 目的 + 影響範囲）
- もしくはローカル差分（branch / commit / diff）

> PR が無い場合でも、最低限「対象ブランチ」「変更差分（diff）」「目的」を提示する。

---

## 重要ルール（Convoy品質ガード）
- **差分根拠**: “なぜその変更が必要か” を説明できない差分は Risk
- **最小変更**: 目的に直結しない改変（リネーム祭り、無関係な整形、広範囲リファクタ）は原則禁止
- **破壊的操作は承認必須**: 削除/移動/強制push/依存更新/デプロイ等はユーザー確認
- **リンク切れ禁止**: README/docs のリンクは大小文字も含めて確認（GitHubは大小文字を区別）

---

# 手順

## Step 1: 変更内容の把握（What / Why）
以下を確認して「変更の目的」を1〜2文で言語化する。

- 変更されたファイル一覧
- diff（追加/変更/削除）
- コミットメッセージ / PR説明
- 関連Issue（あれば）

**出力（必須）**
- 目的: `<この変更は何を解決する?>`
- 影響範囲: `<どの機能/導線/データに影響?>`

---

## Step 2: アーキテクチャレビュー（Fit）
設計レベルでの不整合を潰す。

- 既存のアーキテクチャ/責務分割と整合しているか
- レイヤー分離（UI/状態/ドメイン/IO）の境界が崩れていないか
- 過度な複雑性（条件分岐の増殖、循環依存、God Object）が導入されていないか
- “今すぐ必要ない拡張性” を理由に複雑化していないか

**チェック例**
- 新しい依存を入れるなら、代替案・影響・ロールバックが提示されているか
- 状態管理が散っていないか（SoTと派生の区別）

---

## Step 3: 仕様整合（SoT参照）
- `assets/branding/<productId>/brief.md` と矛盾していないか（UI方針、対象プラットフォーム、品質ゲート）
- Discovery成果物（docs/products/<productId>/...）がある場合、要求・状態遷移と矛盾がないか
- 仕様変更を含む場合は **Decision（選択肢/判断基準/推奨案）** を明示し、勝手に確定しない

---

## Step 4: コード品質チェック（Readability / Maintainability / Type Safety）
### 4.1 可読性
- 命名が意図を表しているか（変数/関数/型）
- 重要な前提がコードから読み取れるか（コメントに逃げていないか）
- ネストが深すぎないか（早期return等で整理されているか）

### 4.2 保守性
- 単一責任（1関数/1コンポーネントの責務が過剰でないか）
- 重複（DRY）と抽象化のバランスが良いか（抽象化しすぎて読めなくしていないか）
- テストしやすい形になっているか（副作用が隔離されているか）

### 4.3 型/境界の安全
- 境界（外部入力/API/ストレージ）で検証・型付けされているか
- null/undefined の扱いが明確か
- “握りつぶし” になっていないか（例: try/catchで黙殺）

---

## Step 5: セキュリティチェック（Security）
- シークレットがハードコードされていないか
- ユーザー入力や外部データが無検証で利用されていないか
- ログに機微情報が出ないか
- 認証/認可が必要な操作が無防備になっていないか

> 破壊的変更や外部連携が入る場合、脅威と対策を短くても良いので提示させる。

---

## Step 6: テスト・検証（Evidence） // turbo
**“動いた” は証拠にならない。** 必ず根拠を残す。

- 変更に対応するテストがあるか（追加/更新）
- エッジケースがカバーされているか
- 失敗時の挙動（エラー表示・リトライ・フォールバック）が妥当か
- `brief.md` に沿った品質ゲート（lint/test/build 等）を通せるか

**任意（利用可能なら）**
- `/review-repo-quality` の結果を添付し、Pass/Risk/Action で補強する

---

## Step 7: 出荷判断（Pass / Risk / Action）
レビュー結果を次の形式でまとめる。

- **Pass**: 出荷可能。軽微な改善は Suggestion/Should Fix へ
- **Risk**: 出荷に懸念。Action を提示し、完了までマージ/リリースを止める
- **Action**: 具体的な修正手順（最小ステップ、確認方法つき）

---

## Step 8: レビュー結果の報告（テンプレ）
以下のテンプレで報告する。

```markdown
## ✅ Code Review Summary

### 目的（What/Why）
- <変更目的を1-2文>

### 影響範囲（Impact）
- <影響する機能/画面/データ/API>

### 出荷判断（Pass / Risk）
- 判定: Pass / Risk
- 根拠: <主要な根拠>

---

## Must Fix（必須修正）
- [ ] <重大な問題 / セキュリティ / 仕様矛盾 / 回帰リスク>

## Should Fix（推奨修正）
- [ ] <改善が望ましい点（可読性/保守性/設計）>

## Suggestion（提案）
- <任意の提案。好みレベル/将来改善案>

## Good Points（良かった点）
- <優れている部分、判断が良い点>

---

### 検証（Evidence）
- 実行した確認: <lint/test/build/手動スモーク 等>
- 結果: Pass / Fail
- 追加テスト: <追加/更新したテスト>
```

---

## 付録: 典型的なMust Fixの例
- 仕様SoT（brief/docs）と矛盾している
- セキュリティ上の穴（シークレット露出、入力無検証、認可欠落）
- 回帰リスクが高いのにテスト/検証根拠がない
- 目的と無関係な大規模変更が混ざっている（差分肥大化）
- README/docsのリンク切れ、大小文字ミス（GitHubで破綻）

---

## 付録: 典型的なShould Fixの例
- 命名・分割で可読性が上がる
- 例外処理の粒度が粗い（原因追跡しにくい）
- テストのエッジケースが薄い
- 重複コードの整理（ただし抽象化しすぎない）

---

レビューは「正しさの押し付け」じゃない。  
**出荷できる状態へ最短で導く**ための共同作業となります。


